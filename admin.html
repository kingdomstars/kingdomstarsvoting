<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Kingdom Stars Admin</title>
</head>

<body>

<h1>‚öôÔ∏è Kingdom Stars ‚Äì Admin Panel</h1>

<!-- üîê AUTH CHECK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
  firebase.auth().onAuthStateChanged(user => {
    if (!user) {
      window.location.href = "login.html";
    }
  });
</script>

<hr>

<!-- üîò VOTING CONTROLS -->
<h2>‚öôÔ∏è Voting Controls</h2>
<button onclick="enableMM()">Enable Mobile Money</button>
<button onclick="disableMM()">Disable Mobile Money</button>

<hr>

<!-- üìä RESULTS -->
<h2>üìä Vote Results</h2>
<div id="results"></div>

<hr>

<!-- üì§ EXPORT -->
<h2>üì§ Export Results</h2>
<button onclick="exportExcel()">Export to Excel</button>
<button onclick="exportPDF()">Export to PDF</button>

<hr>

<!-- üì± MOBILE MONEY APPROVAL -->
<h2>üì± Mobile Money Votes (Confirm)</h2>
<div id="mobileVotes"></div>

<!-- üìö LIBRARIES -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- üîß YOUR MAIN SCRIPT -->
<script src="script.js"></script>

<!-- üîò MOBILE MONEY SWITCH -->
<script>
function enableMM() {
  db.collection("settings").doc("voting").set({ mobileMoney: true });
  alert("‚úÖ Mobile Money Voting ENABLED");
}

function disableMM() {
  db.collection("settings").doc("voting").set({ mobileMoney: false });
  alert("‚ùå Mobile Money Voting DISABLED");
}
</script>

<!-- üìä DISPLAY RESULTS -->
<script>
db.collection("contestants").onSnapshot(snapshot => {
  document.getElementById("results").innerHTML = "";
  snapshot.forEach(doc => {
    db.collection("votes")
      .where("contestantId", "==", doc.id)
      .get()
      .then(votes => {
        document.getElementById("results").innerHTML +=
          `<p><strong>${doc.data().name}</strong>: ${votes.size} votes</p>`;
      });
  });
});
</script>

<!-- üì± MOBILE MONEY APPROVAL (BUNDLES) -->
<script>
db.collection("mobileVotes")
  .where("status", "==", "pending")
  .onSnapshot(snapshot => {
    mobileVotes.innerHTML = "";
    snapshot.forEach(doc => {
      const d = doc.data();
      mobileVotes.innerHTML += `
        <p>
          <strong>${d.name}</strong> ‚Äì ${d.phone}<br>
          TXN: ${d.transactionId}<br>
          <strong>${d.votes} votes</strong>
          <button onclick="approve('${doc.id}', '${d.contestantId}', ${d.votes})">
            Approve
          </button>
        </p>
        <hr>
      `;
    });
  });

function approve(id, contestantId, votes) {
  for (let i = 0; i < votes; i++) {
    db.collection("votes").add({
      contestantId: contestantId,
      paid: true,
      time: new Date()
    });
  }

  db.collection("mobileVotes").doc(id).update({
    status: "approved"
  });

  alert("‚úÖ Vote Approved");
}
</script>

</body>
</html>
